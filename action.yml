name: 'insta-integration - Integration Testing'
description: 'Automatically run integration tests for any application or job'
author: 'Data Catering'
branding:
  icon: 'check-square'
  color: 'green'

# Define your inputs here.
inputs:
  configuration_file:
    description: 'File path to configuration file.'
    default: 'insta-integration.yaml'
  insta_infra_folder:
    description: 'Folder path to insta-infra.'
    default: 'integration-test/insta-infra'
  base_folder:
    description: 'Folder path to use for execution files.'
    default: '/tmp/insta-integration'

# Define your outputs here.
outputs:
  num_records_generated:
    value: ${{ steps.insta-integration.outputs.num_records_generated }}
    description: 'Total number of records generated.'
  num_success_validations:
    value: ${{ steps.insta-integration.outputs.num_success_validations }}
    description: 'Total number of successful validations.'
  num_failed_validations:
    value: ${{ steps.insta-integration.outputs.num_failed_validations }}
    description: 'Total number of failed validations.'
  num_validations:
    value: ${{ steps.insta-integration.outputs.num_validations }}
    description: 'Total number of validations.'
  validation_success_rate:
    value: ${{ steps.insta-integration.outputs.validation_success_rate }}
    description: 'Success rate of validations (i.e. 0.75 = 75% success rate).'

runs:
  using: 'composite'
  steps:
    - name: 'Checkout insta-infra repo'
      uses: 'actions/checkout@v4'
      with:
        repository: 'data-catering/insta-infra'
        path: '${{ inputs.insta_infra_folder }}'
    - name: 'Run integration tests'
      id: 'insta-integration'
      uses: 'actions/github-script@v6'
      with:
        script: |
          const { script } = require("${{ github.action_path }}/dist/index.js")
          script()
      env:
        CONFIGURATION_FILE: '${{ inputs.configuration_file }}'
        INSTA_INFRA_FOLDER: '${{ inputs.insta_infra_folder }}'
        BASE_FOLDER: '${{ github.action_path }}'
    - name: 'Cache Docker images'
      id: 'docker-cache'
      uses: 'ScribeMD/docker-cache@0.5.0'
      with:
        key:
          docker-${{ runner.os }}-${{
          hashFiles(format('{0}/docker-compose.yaml',
          inputs.insta_infra_folder)) }}
